#!/command/with-contenv bashio
# ==============================================================================
# Home Assistant Community Add-on: Spotify Connect
# Runs librespot
# ==============================================================================
declare -a options
declare name
declare password
declare username

until [ -e /run/avahi-daemon/pid ]; do
  sleep 1s
done

bashio::log.info 'Starting the Spotify daemon...'

# Device name
name=$(bashio::config 'spotify_name')
options+=(--name "${name}")

# Username / password
if bashio::config.has_value 'spotify_username'; then
    bashio::config.require.spotify_password

    username=$(bashio::config 'spotify_username')
    password=$(bashio::config 'spotify_password')

    options+=(--username "${username}")
    options+=(--password "${password}")
fi

# Save writes
options+=(--disable-audio-cache)

# Stream to pipe
options+=(--backend pipe)
options+=(--device /usr/share/librespot)

# Are we running in debug mode?
if bashio::debug; then
  options+=(--verbose)
fi

# Run librespot
exec librespot "${options[@]}"